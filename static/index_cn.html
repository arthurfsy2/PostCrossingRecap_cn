<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>è·å–å¹´åº¦å›é¡¾</title>
    <link rel="stylesheet" href="./bootstrap.min.css">

    <!-- å¼•å…¥Bootstrap CSS -->
    <link rel="stylesheet" href="./bootstrap.min.css">
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">


    <style>
        /* åœ¨è¿™é‡Œæ·»åŠ æ‚¨çš„CSSæ ·å¼ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            text-align: center;
            font-size: 1.5em;
            margin: 0;
            margin-top: 1em;
        }

        h3 {
            color: #000000;
            text-shadow: 0px 0px 16px #ffe476;
        }

        .margin-top-20px {
            margin-top: 20px;
        }

        footer {
            --mask:
                radial-gradient(22.36px at 50% 30.00px, #000 99%, #0000 101%) calc(50% - 20px) 0/40px 100%,
                radial-gradient(22.36px at 50% -20px, #0000 99%, #000 101%) 50% 10px/40px 100% repeat-x;
            -webkit-mask: var(--mask);
            mask: var(--mask);
            background-color: #ffe6b1;
            padding-top: 20px;
            padding-bottom: 10px;
            text-align: center;
            font-size: 0.8em;
        }

        .language-switcher {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .language-switcher .dropdown-menu {
            min-width: 5rem;
        }
    </style>

</head>

<body>
    <!-- <img src="./recap/src/logo.png" alt="Postcrossing logo" style="width: 50%; height: auto;" /> -->
    <div class="container mt-3">
        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šç”Ÿæˆæ•°æ® -->
        <h3 id="generate-data-title">ç”Ÿæˆæ•°æ®</h3>
        <form>
            <div class="form-group mt-3">

                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon1"><i class="fa fa-user"></i></span>
                    </div>
                    <input type="text" class="form-control" id="account" placeholder="è¯·è¾“å…¥postcrossingè´¦å·"
                        aria-describedby="basic-addon1">
                </div>
            </div>
            <div class="form-group mt-3">

                <div class="input-group">
                    <div class="input-group-prepend">
                        <span class="input-group-text" id="basic-addon2"><i class="fa fa-lock"></i></span>
                    </div>
                    <input type="password" class="form-control" id="password" placeholder="è¯·è¾“å…¥postcrossingå¯†ç "
                        aria-describedby="basic-addon2">
                </div>
            </div>
            <div class="form-group mt-3 text-center">

                <div class="row justify-content-center">
                    <div class="col-auto">
                        <div class="custom-control custom-radio custom-control-inline">
                            <input class="custom-control-input" type="radio" name="lang" id="lang-cn" value="cn">
                            <label class="custom-control-label" for="lang-cn">ä¸­æ–‡ (cn)</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="custom-control custom-radio custom-control-inline">
                            <input class="custom-control-input" type="radio" name="lang" id="lang-en" value="en">
                            <label class="custom-control-label" for="lang-en">è‹±æ–‡ (en)</label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="custom-control custom-radio custom-control-inline">
                            <input class="custom-control-input" type="radio" name="lang" id="lang-all" value="all"
                                checked>
                            <label class="custom-control-label" for="lang-all">å…¨éƒ¨ï¼ˆcn+enï¼‰</label>
                        </div>
                    </div>
                </div>
            </div>


            <button id="run-script" class="btn btn-primary mt-3">ç”Ÿæˆå¹´åº¦å›é¡¾</button>
        </form>
        <div id="file-list-container" class="mt-3"></div>
        <div id="calendar-container" class="mt-3"></div>
        </div>
    </div>

    <hr>

    <h3 id="search-data-title">æŸ¥è¯¢æ•°æ®</h3>
    <div class="form-group">

        <div class="col-12 col-md-10 mx-auto"></div>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="search-account" placeholder="è¯·åœ¨ç”Ÿæˆåï¼Œå†è¾“å…¥postcrossingè´¦å·è¿›è¡ŒæŸ¥è¯¢â€¦â€¦">
        </div>
    </div>
    <button id="search-files" class="btn btn-primary margin-top-20px">æŸ¥è¯¢</button>
    <button id="download-files" class="btn btn-success margin-top-20px" style="display: none;"
        onclick="downloadFile()">ä¸‹è½½zip</button>
    <button id="delete-files" class="btn btn-danger margin-top-20px" style="display: none;"
        onclick="confirmDelete()">åˆ é™¤</button>
    </div>
    <div id="search-list-container" class="mt-3"></div>
    <div id="calendar-container2" class="mt-3"></div>
    </div>


    <script>
        document.getElementById('run-script').addEventListener('click', function () {
            const runScriptButton = document.getElementById('run-script');
            const account = document.getElementById('account').value.trim();
            const password = document.getElementById('password').value;
            const lang = document.querySelector('input[name="lang"]:checked').value;
            // æ£€æŸ¥æœç´¢æ¡†å†…å®¹æ˜¯å¦ä¸ºç©º
            if (account === '') {
                alert('è¯·è¾“å…¥è´¦å·');
                return; // å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºå¹¶é€€å‡ºå‡½æ•°
            }
            // ç¦ç”¨æŒ‰é’®å¹¶æ›´æ”¹æŒ‰é’®æ–‡æœ¬
            runScriptButton.disabled = true;
            runScriptButton.textContent = 'ç”Ÿæˆä¸­â€¦â€¦';

            fetch('/run-script', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `account=${encodeURIComponent(account)}&password=${encodeURIComponent(password)}&lang=${encodeURIComponent(lang)}`
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        setTimeout(() => {
                            fetch('/list-recap-files', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: `account=${encodeURIComponent(account)}`
                            })
                                .then(response => response.json())
                                .then(files => {
                                    const fileListContainer = document.getElementById('file-list-container');
                                    fileListContainer.innerHTML = ''; // æ¸…ç©ºæ–‡ä»¶åˆ—è¡¨å®¹å™¨
                                    const calendarContainer = document.getElementById('calendar-container');
                                    calendarContainer.innerHTML = ''; // æ¸…ç©ºæ—¥å†å®¹å™¨
                                    
                                    files.forEach(file => {
                                        const fileLink = document.createElement('a');
                                        fileLink.href = `/static/recap/${file}`; // ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                                        fileLink.textContent = file;
                                        fileLink.target = '_blank'; // åœ¨æ–°çª—å£ä¸­æ‰“å¼€
                                        fileListContainer.appendChild(fileLink);
                                        fileListContainer.appendChild(document.createElement('br'));
                                       
                                    });
                                     // åˆ›å»º iframe å…ƒç´ å¹¶è®¾ç½®å…¶å±æ€§
                                     const iframe = document.createElement('iframe');
                                        iframe.src = `/static/recap/${account}_calendar_cn.html`; // è®¾ç½® iframe çš„ src å±æ€§
                                        iframe.width = '70%'; // è®¾ç½® iframe çš„å®½åº¦
                                        iframe.height = '600'; // è®¾ç½® iframe çš„é«˜åº¦
                                        iframe.frameBorder = '0'; // å¯é€‰ï¼šç§»é™¤ iframe è¾¹æ¡†

                                        // å°† iframe æ·»åŠ åˆ° map-container ä¸­
                                        calendarContainer.appendChild(iframe);
                                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                                    runScriptButton.disabled = false;
                                    runScriptButton.textContent = 'ç”Ÿæˆå¹´åº¦å›é¡¾';
                                });
                        });
                        alert('æç¤ºï¼š\n' + data.output);
                    } else {
                        alert('æç¤ºï¼š\n' + data.output);
                        // å¦‚æœå¤±è´¥ï¼Œä¹Ÿæ¢å¤æŒ‰é’®çŠ¶æ€
                        runScriptButton.disabled = false;
                        runScriptButton.textContent = 'ç”Ÿæˆå¹´åº¦å›é¡¾';
                    }
                }).catch(error => {
                    // å¤„ç†ç½‘ç»œé”™è¯¯ç­‰é—®é¢˜
                    alert('å‘ç”Ÿé”™è¯¯ï¼š\n' + error);
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    runScriptButton.disabled = false;
                    runScriptButton.textContent = 'ç”Ÿæˆå¹´åº¦å›é¡¾';
                });
        });


        document.getElementById('search-files').addEventListener('click', function () {
            const searchAccount = document.getElementById('search-account').value.trim(); // ä½¿ç”¨trim()å»é™¤ä¸¤ç«¯ç©ºç™½å­—ç¬¦

            // æ£€æŸ¥æœç´¢æ¡†å†…å®¹æ˜¯å¦ä¸ºç©º
            if (searchAccount === '') {
                alert('è¯·è¾“å…¥è´¦å·');
                return; // å¦‚æœä¸ºç©ºï¼Œæ˜¾ç¤ºæç¤ºå¹¶é€€å‡ºå‡½æ•°
            }

            // ç¦ç”¨æŸ¥è¯¢æŒ‰é’®å¹¶æ›´æ”¹æŒ‰é’®æ–‡æœ¬
            const searchButton = document.getElementById('search-files');
            searchButton.disabled = true;
            searchButton.textContent = 'æŸ¥è¯¢ä¸­â€¦â€¦';

            // å‘é€æŸ¥è¯¢è¯·æ±‚
            fetch('/list-recap-files', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `account=${encodeURIComponent(searchAccount)}`
            })
                .then(response => response.json())
                .then(files => {
                    const searchListContainer = document.getElementById('search-list-container');
                    searchListContainer.innerHTML = ''; // æ¸…ç©ºæœç´¢ç»“æœå®¹å™¨
                    const calendarContainer2 = document.getElementById('calendar-container2');
                    calendarContainer2.innerHTML = ''; // æ¸…ç©ºæ—¥å†å®¹å™¨
                    // è¿‡æ»¤å‡ºå®Œå…¨åŒ¹é…è´¦å·çš„æ–‡ä»¶
                    const matchedFiles = files.filter(file =>
                        file.startsWith(`${searchAccount}_`) && (file.endsWith('.html') || file.endsWith('.zip'))
                    );

                    if (matchedFiles.length === 0) {
                        // å¦‚æœæ²¡æœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œåˆ™æ˜¾ç¤ºâ€œæ— æŸ¥è¯¢ç»“æœâ€
                        searchListContainer.textContent = '"' + searchAccount + '"è´¦å·æœªæŸ¥è¯¢åˆ°å¹´åº¦å›é¡¾ï¼Œè¯·ç”Ÿæˆæ•°æ®ã€‚';
                    } else {
                        // å¦‚æœæœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œåˆ™æ˜¾ç¤ºé“¾æ¥
                        matchedFiles.forEach(file => {
                            const fileLink = document.createElement('a');
                            fileLink.href = `/static/recap/${file}`; // ä½¿ç”¨ç›¸å¯¹è·¯å¾„
                            fileLink.textContent = file;
                            fileLink.target = '_blank'; // åœ¨æ–°çª—å£ä¸­æ‰“å¼€
                            searchListContainer.appendChild(fileLink);
                            searchListContainer.appendChild(document.createElement('br'));
                        });
                        // å¦‚æœæœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œåˆ™æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                        document.getElementById('download-files').style.display = 'inline-block';
                        document.getElementById('delete-files').style.display = 'inline-block';
                        // åˆ›å»º iframe å…ƒç´ å¹¶è®¾ç½®å…¶å±æ€§
                        const iframe = document.createElement('iframe');
                        iframe.src = `/static/recap/${searchAccount}_calendar_cn.html`; // è®¾ç½® iframe çš„ src å±æ€§
                        iframe.width = '70%'; // è®¾ç½® iframe çš„å®½åº¦
                        iframe.height = '600'; // è®¾ç½® iframe çš„é«˜åº¦
                        iframe.frameBorder = '0'; // å¯é€‰ï¼šç§»é™¤ iframe è¾¹æ¡†

                        // å°† iframe æ·»åŠ åˆ° map-container ä¸­
                        calendarContainer2.appendChild(iframe);
                        }

                    // æ¢å¤æŸ¥è¯¢æŒ‰é’®çŠ¶æ€
                    searchButton.disabled = false;
                    searchButton.textContent = 'æŸ¥è¯¢';
                }).catch(error => {
                    // å¤„ç†ç½‘ç»œé”™è¯¯ç­‰é—®é¢˜
                    alert('å‘ç”Ÿé”™è¯¯ï¼š\n' + error);
                    // æ¢å¤æŸ¥è¯¢æŒ‰é’®çŠ¶æ€
                    searchButton.disabled = false;
                    searchButton.textContent = 'æŸ¥è¯¢';
                });
        });


        function downloadFile() {
            // è·å–è¾“å…¥æ¡†ä¸­çš„è´¦å·
            var account = document.getElementById('search-account').value;
            // å¦‚æœè´¦å·éç©ºï¼Œåˆ™æ‹¼æ¥æ–‡ä»¶è·¯å¾„å¹¶è§¦å‘ä¸‹è½½
            if (account) {
                var filePath = './recap/' + encodeURIComponent(account) + '_recap.zip';
                // åˆ›å»ºä¸€ä¸ªaæ ‡ç­¾ç”¨äºä¸‹è½½
                var downloadLink = document.createElement('a');
                downloadLink.href = filePath;
                downloadLink.download = account + '_recap.zip';
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            } else {
                // å¦‚æœè¾“å…¥æ¡†ä¸ºç©ºï¼Œåˆ™å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æç¤ºç”¨æˆ·è¾“å…¥è´¦å·çš„ä»£ç 
                alert('è¯·è¾“å…¥è´¦å·è¿›è¡ŒæŸ¥è¯¢');
            }
        }

        function confirmDelete() {
            var account = document.getElementById('search-account').value;
            if (account) {
                var confirmResponse = confirm('ç¡®å®šåˆ é™¤æ‰€æœ‰' + account + 'çš„æ•°æ®å—ï¼Ÿ');
                if (confirmResponse) {
                    // ç”¨æˆ·ç‚¹å‡»äº†ç¡®å®šï¼Œå‘é€è¯·æ±‚åˆ°Flaskåç«¯è¿›è¡Œåˆ é™¤æ“ä½œ

                    fetch('/delete-endpoint', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `account=${encodeURIComponent(account)}`
                    })
                        .then(response => response.json())
                        .then(data => {
                            // å¤„ç†å“åº”æ•°æ®
                            console.log(data);
                            var messageContainer = document.getElementById('message-container');
                            if (data.success) {
                                alert('åˆ é™¤æˆåŠŸã€‚' + (data.output || ''));
                            } else {
                                alert('åˆ é™¤å¤±è´¥ï¼š' + (data.output || ''));
                            }
                            location.reload();
                        })
                        .catch((error) => {
                            // å¤„ç†è¯·æ±‚é”™è¯¯
                            console.error('Error:', error);
                            alert('è¯·æ±‚é”™è¯¯ï¼š' + error);
                            // å‘ç”Ÿé”™è¯¯æ—¶ä¹Ÿåˆ·æ–°é¡µé¢
                            location.reload();
                        });
                } else {
                    // ç”¨æˆ·ç‚¹å‡»äº†å–æ¶ˆï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                }
            } else {
                alert('è¯·è¾“å…¥è´¦å·è¿›è¡ŒæŸ¥è¯¢');
            }
        }


    </script>
    <script src="./bootstrap.min.js"></script>
    <script src="./bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
    <script src="./bootstrap.min.js"></script>

    <!-- åœ¨ä½ çš„HTMLæ–‡ä»¶ä¸­æ·»åŠ è¿™ä¸ªfooteréƒ¨åˆ† -->
    <footer>
        <p>ğŸ›ˆæœ¬é¡¹ç›®ä¸postcrossingå®˜æ–¹æ— å…³ï¼ä¸”æœ¬ç½‘ç«™ä¸ä¼šå­˜å‚¨ä½ çš„ä¸ªäººè´¦å·ã€å¯†ç ï¼Œåªä¼šç”¨äºä¸ªäººæ•°æ®çš„ç”Ÿæˆã€‚</p>
        <p>å¦‚æœä¸å†éœ€è¦ï¼Œå»ºè®®ç”Ÿæˆååˆ é™¤ä¸ªäººæ–‡ä»¶ã€‚</p>
        <div class="text-center p-3">
            ç”±<a class="text-dark fab fa-github" href="https://github.com/arthurfsy2/PostCrossingRecap_cn"
                target="_blank">arthurfsy2/PostCrossingRecap_cn</a>ç”Ÿæˆ
        </div>
        <div class="text-center p-3">
            å¹´åº¦å›é¡¾é¡µé¢ã€cssæ ·å¼å‚è€ƒäº†<a class="text-dark fab fa-github" href="https://github.com/cnovel/PostCrossingRecap"
                target="_blank">cnovel/PostCrossingRecap</a>çš„ä»£ç 
        </div>
    </footer>
</body>

</html>